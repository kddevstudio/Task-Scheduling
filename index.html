<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Kendo Gannt Test</title>
        <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.3.914/styles/kendo.common.min.css" crossorigin="anonymous"/>
        <link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.3.914/styles/kendo.default.min.css" crossorigin="anonymous" />
        <script src="https://kendo.cdn.telerik.com/2021.3.914/js/jquery.min.js" crossorigin="anonymous"></script>
        <script src="https://kendo.cdn.telerik.com/2021.3.914/js/kendo.all.min.js" crossorigin="anonymous"></script>
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <script src="./dist/Scheduler.js" type="module"></script>
        <script src="./dist/TaskRepository.js" type="module"></script>
        <style>
            #grid{
                height: 800px;
            }
        </style>
    </head>
    <body>
        <div id="gantt"></div>
    </body>
    <script>
        var serviceRoot = "https://demos.telerik.com/kendo-ui/service";
            var tasksDataSource = new kendo.data.GanttDataSource({
                transport: {
                    read: {
                        url: serviceRoot + "/GanttTasks",
                        dataType: "jsonp"
                    },
                    update: {
                        url: serviceRoot + "/GanttTasks/Update",
                        dataType: "jsonp",
                        timeout: 5000
                    },
                    destroy: {
                        url: serviceRoot + "/GanttTasks/Destroy",
                        dataType: "jsonp",
                        timeout: 5000
                    },
                    create: {
                        url: serviceRoot + "/GanttTasks/Create",
                        dataType: "jsonp",
                        timeout: 5000
                    },
                    parameterMap: function (options, operation) {
                        if (operation !== "read") {
                            return { models: kendo.stringify(options.models || [options]) };
                        }
                    }
                },
                schema: {
                    model: {
                        id: "id",
                        fields: {
                            id: { from: "ID", type: "number" },
                            orderId: { from: "OrderID", type: "number", validation: { required: true } },
                            parentId: { from: "ParentID", type: "number", defaultValue: null, nullable: true, validation: { required: true } },
                            start: { from: "Start", type: "date" },
                            end: { from: "End", type: "date" },
                            title: { from: "Title", defaultValue: "", type: "string" },
                            percentComplete: { from: "PercentComplete", type: "number" },
                            summary: { from: "Summary", type: "boolean" },
                            expanded: { from: "Expanded", type: "boolean", defaultValue: true }
                        }
                    }
                },
                error: function (ev) {
                    ev.sender.cancelChanges();
                    kendo.alert("Task was not Created, Updated or Destroyed properly!</br></br>" +
                                "If you are using this service for local demo or in dojo consider <a href='https://github.com/telerik/kendo-ui-demos-service/tree/master/demos-and-odata-v3'>downloading and running the service locally</a>.</br>" +
                                "And make sure to set the <a href='https://github.com/telerik/kendo-ui-demos-service/blob/master/demos-and-odata-v3/KendoCRUDService/Models/Gantt/GanttTaskRepository.cs#L12'>UpdateDatabase</a> flag to true.");
                }
            });

            var dependenciesDataSource = new kendo.data.GanttDependencyDataSource({
                transport: {
                    read: {
                        url: serviceRoot + "/GanttDependencies",
                        dataType: "jsonp"
                    },
                    update: {
                        url: serviceRoot + "/GanttDependencies/Update",
                        dataType: "jsonp"
                    },
                    destroy: {
                        url: serviceRoot + "/GanttDependencies/Destroy",
                        dataType: "jsonp"
                    },
                    create: {
                        url: serviceRoot + "/GanttDependencies/Create",
                        dataType: "jsonp"
                    },
                    parameterMap: function (options, operation) {
                        if (operation !== "read") {
                            return { models: kendo.stringify(options.models || [options]) };
                        }
                    }
                },
                schema: {
                    model: {
                        id: "id",
                        fields: {
                            id: { from: "ID", type: "number" },
                            predecessorId: { from: "PredecessorID", type: "number" },
                            successorId: { from: "SuccessorID", type: "number" },
                            type: { from: "Type", type: "number" }
                        }
                    }
                }
            });

            var gantt = $("#gantt").kendoGantt({
                dataSource: tasksDataSource,
                dependencies: dependenciesDataSource,
                moveStart: function(e){
                    console.dir(e);
                },
                moveEnd: function(e){
                    console.dir(e.task.task.title);
                    console.log(`Moving task ${e.task.TaskID} from ${e.task.start} to ${e.start}`);
                    var taskRepository = new TaskRepository(tasksDataSource.data(), dependenciesDataSource.data());
                    var scheduler = new Scheduler(taskRepository);
                    var taskMoveResult = scheduler.move(TaskActionSource.User, e.task, e.start);

                    if(!taskMoveResult.isValid){
                        e.preventDefault();
                    }
                },    
                resources: {
                    field: "resources",
                    dataColorField: "Color",
                    dataTextField: "Name",
                    dataSource: {
                        transport: {
                            read: {
                                url: serviceRoot + "/GanttResources",
                                dataType: "jsonp"
                            }
                        },
                        schema: {
                            model: {
                                id: "id",
                                fields: {
                                    id: { from: "ID", type: "number" }
                                }
                            }
                        }
                    }
                },
                assignments: {
                    dataTaskIdField: "TaskID",
                    dataResourceIdField: "ResourceID",
                    dataValueField: "Units",
                    dataSource: {
                        transport: {
                            read: {
                                url: serviceRoot + "/GanttResourceAssignments",
                                dataType: "jsonp"
                            },
                            update: {
                                url: serviceRoot + "/GanttResourceAssignments/Update",
                                dataType: "jsonp"
                            },
                            destroy: {
                                url: serviceRoot + "/GanttResourceAssignments/Destroy",
                                dataType: "jsonp"
                            },
                            create: {
                                url: serviceRoot + "/GanttResourceAssignments/Create",
                                dataType: "jsonp"
                            },
                            parameterMap: function (options, operation) {
                                if (operation !== "read") {
                                    return { models: kendo.stringify(options.models || [options]) };
                                }
                            }
                        },
                        schema: {
                            model: {
                                id: "ID",
                                fields: {
                                    ID: { type: "number" },
                                    ResourceID: { type: "number" },
                                    Units: { type: "number" },
                                    TaskID: { type: "number" }
                                }
                            }
                        }
                    }
                },
                views: [
                    "day",
                    { type: "week", selected: true },
                    "month"
                ],
                columns: [
                    { field: "title", title: "Task", editable: true, width: 255 },
                    { field: "start", title: "Actual Start Date", format: "{0:M/d/yyyy}", editable: true, width: 130 },
                    { field: "end", title: "Actual End Date", format: "{0:M/d/yyyy}", editable: true, width: 130 },
                    { field: "percentComplete", title: "% Complete", type: "number", editable: true, width: 100 }
                ],
                toolbar: ["append", "pdf"],
                height: 700,
                listWidth: "50%",
                showWorkHours: false,
                showWorkDays: false,
                snap: false,
                dataBound: function(e){

                }
            }).data("kendoGantt");

                

            $(document).bind("kendo:skinChange", function () {
                gantt.refresh();
            });
    </script>
</html>